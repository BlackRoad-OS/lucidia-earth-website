<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackRoad OS ‚Äî Living Earth with Biomes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }
        #canvas-container { position: fixed; inset: 0; }

        .ui {
            position: fixed;
            z-index: 100;
            pointer-events: none;
        }
        .ui > * { pointer-events: auto; }

        .logo {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.75);
            padding: 10px 18px;
            border-radius: 50px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }
        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, #FF1D6C, #F5A623);
            border-radius: 50%;
            position: relative;
        }
        .logo-icon::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 10px; height: 10px;
            background: #000;
            border-radius: 50%;
        }
        .logo-text { color: #fff; font-weight: 600; font-size: 14px; }

        .stats-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.75);
            padding: 10px 24px;
            border-radius: 50px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }
        .stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stat-icon { font-size: 15px; }
        .stat-value { font-size: 13px; font-weight: 600; color: #fff; }

        .biome-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.75);
            padding: 14px 18px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            min-width: 200px;
        }
        .biome-title {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(255,255,255,0.4);
            margin-bottom: 10px;
        }
        .biome-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .biome-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        .biome-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
        }
        .biome-count {
            margin-left: auto;
            color: rgba(255,255,255,0.5);
            font-size: 11px;
        }

        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.75);
            padding: 16px 20px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            max-width: 320px;
        }
        .info-panel.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .info-biome {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
        }
        .info-name {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }
        .info-desc {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            line-height: 1.5;
        }
        .info-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .info-stat {
            text-align: center;
        }
        .info-stat-icon { font-size: 16px; }
        .info-stat-value { font-size: 14px; font-weight: 600; color: #fff; }
        .info-stat-label { font-size: 8px; color: rgba(255,255,255,0.4); text-transform: uppercase; }

        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 100;
        }
        .ctrl-btn {
            width: 42px; height: 42px;
            border: none;
            border-radius: 50%;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ctrl-btn:hover {
            background: rgba(255,29,108,0.4);
            transform: scale(1.1);
        }
        .ctrl-btn.active {
            background: #FF1D6C;
            border-color: #FF1D6C;
        }

        .loading {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.8s ease;
        }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #1a5a2e, #c2b280, #2d7a47, #87ceeb, #1e5a7f);
            animation: spin 2s linear infinite;
            position: relative;
        }
        .loading-spinner::before {
            content: '';
            position: absolute;
            inset: 4px;
            background: #000;
            border-radius: 50%;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: rgba(255,255,255,0.7); font-size: 14px; }
        .loading-bar {
            width: 160px; height: 2px;
            background: rgba(255,255,255,0.1);
            border-radius: 1px;
            margin-top: 12px;
            overflow: hidden;
        }
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #FF1D6C, #F5A623);
            width: 0%;
            transition: width 0.15s ease;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Generating biomes...</div>
        <div class="loading-bar"><div class="loading-progress" id="loadingProgress"></div></div>
    </div>

    <div id="canvas-container"></div>

    <div class="logo">
        <div class="logo-icon"></div>
        <span class="logo-text">BlackRoad Living Earth</span>
    </div>

    <div class="stats-bar">
        <div class="stat"><span class="stat-icon">üå≥</span><span class="stat-value" id="treeCount">0</span></div>
        <div class="stat"><span class="stat-icon">üè†</span><span class="stat-value" id="houseCount">0</span></div>
        <div class="stat"><span class="stat-icon">üêæ</span><span class="stat-value" id="animalCount">0</span></div>
        <div class="stat"><span class="stat-icon">ü§ñ</span><span class="stat-value" id="agentCount">0</span></div>
        <div class="stat"><span class="stat-icon">üå∏</span><span class="stat-value" id="flowerCount">0</span></div>
    </div>

    <div class="biome-panel">
        <div class="biome-title">World Biomes</div>
        <div class="biome-list" id="biomeList"></div>
    </div>

    <div class="info-panel" id="infoPanel">
        <div class="info-biome" id="infoBiome">Tropical Rainforest</div>
        <div class="info-name" id="infoName">Amazon Basin</div>
        <div class="info-desc" id="infoDesc">The world's largest rainforest...</div>
        <div class="info-stats">
            <div class="info-stat">
                <div class="info-stat-icon">üå≥</div>
                <div class="info-stat-value" id="infoTrees">0</div>
                <div class="info-stat-label">Trees</div>
            </div>
            <div class="info-stat">
                <div class="info-stat-icon">üè†</div>
                <div class="info-stat-value" id="infoHouses">0</div>
                <div class="info-stat-label">Houses</div>
            </div>
            <div class="info-stat">
                <div class="info-stat-icon">üêæ</div>
                <div class="info-stat-value" id="infoAnimals">0</div>
                <div class="info-stat-label">Animals</div>
            </div>
            <div class="info-stat">
                <div class="info-stat-icon">üå°Ô∏è</div>
                <div class="info-stat-value" id="infoTemp">0¬∞</div>
                <div class="info-stat-label">Temp</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn active" id="btnRotate" title="Auto Rotate">üîÑ</button>
        <button class="ctrl-btn active" id="btnClouds" title="Clouds">‚òÅÔ∏è</button>
        <button class="ctrl-btn active" id="btnLife" title="Life">üåø</button>
        <button class="ctrl-btn" id="btnNight" title="Night">üåô</button>
        <button class="ctrl-btn" id="btnLabels" title="Labels">üè∑Ô∏è</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const EARTH_RADIUS = 100;

        const TEXTURES = {
            earth: 'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
            bump: 'https://unpkg.com/three-globe/example/img/earth-topology.png',
            specular: 'https://unpkg.com/three-globe/example/img/earth-water.png',
            clouds: 'https://unpkg.com/three-globe/example/img/earth-clouds.png',
            night: 'https://unpkg.com/three-globe/example/img/earth-night.jpg'
        };

        // ============ BIOME DEFINITIONS ============
        const BIOMES = {
            TROPICAL_RAINFOREST: {
                name: "Tropical Rainforest",
                color: 0x1a5a1a,
                icon: "üå¥",
                temp: "27¬∞C",
                treeTypes: ['tropical', 'palm', 'giant'],
                treeColors: [0x0d5c0d, 0x157a15, 0x1a8a1a, 0x228b22],
                treeDensity: 1.5,
                animals: ['monkey', 'parrot', 'jaguar', 'toucan', 'frog'],
                animalColors: [0x8b4513, 0xff4500, 0xffd700, 0x00ced1],
                flowers: ['orchid', 'heliconia', 'bromeliad'],
                flowerColors: [0xff1493, 0xff4500, 0xffd700, 0xff69b4, 0x9400d3],
                groundColor: 0x2d4a1c
            },
            TEMPERATE_FOREST: {
                name: "Temperate Forest",
                color: 0x2d5a27,
                icon: "üå≤",
                temp: "12¬∞C",
                treeTypes: ['oak', 'maple', 'birch', 'pine'],
                treeColors: [0x228b22, 0x2e8b2e, 0x3cb371, 0x1a5a1a],
                treeDensity: 1.0,
                animals: ['deer', 'rabbit', 'fox', 'owl', 'squirrel'],
                animalColors: [0xd2691e, 0xffffff, 0xff6600, 0x8b4513],
                flowers: ['daisy', 'bluebell', 'violet'],
                flowerColors: [0xffffff, 0x6495ed, 0x9370db, 0xffff00],
                groundColor: 0x3d5a2c
            },
            BOREAL_TAIGA: {
                name: "Boreal Forest / Taiga",
                color: 0x1a4a2a,
                icon: "üå≤",
                temp: "-5¬∞C",
                treeTypes: ['spruce', 'fir', 'pine'],
                treeColors: [0x0a3a0a, 0x154a15, 0x1a5a1a],
                treeDensity: 0.9,
                animals: ['moose', 'wolf', 'bear', 'lynx', 'owl'],
                animalColors: [0x4a3728, 0x808080, 0x3d2914, 0xd2b48c],
                flowers: ['moss', 'lichen'],
                flowerColors: [0x9acd32, 0xb8b8b8],
                groundColor: 0x2a3a1c
            },
            TUNDRA: {
                name: "Tundra",
                color: 0x8fbc8f,
                icon: "‚ùÑÔ∏è",
                temp: "-20¬∞C",
                treeTypes: ['shrub'],
                treeColors: [0x556b2f, 0x6b8e23],
                treeDensity: 0.2,
                animals: ['caribou', 'arctic_fox', 'snowy_owl', 'lemming', 'musk_ox'],
                animalColors: [0xffffff, 0xf5f5f5, 0xd3d3d3, 0x8b7355],
                flowers: ['arctic_poppy', 'moss'],
                flowerColors: [0xffff00, 0x9acd32, 0xffffff],
                groundColor: 0x9aaa8a
            },
            DESERT_HOT: {
                name: "Hot Desert",
                color: 0xc2b280,
                icon: "üèúÔ∏è",
                temp: "38¬∞C",
                treeTypes: ['cactus', 'joshua', 'palm_desert'],
                treeColors: [0x228b22, 0x556b2f, 0x6b8e23],
                treeDensity: 0.15,
                animals: ['camel', 'scorpion', 'snake', 'lizard', 'fennec'],
                animalColors: [0xd2b48c, 0x8b4513, 0xffd700, 0xdaa520],
                flowers: ['desert_rose'],
                flowerColors: [0xff69b4, 0xffa500],
                groundColor: 0xd4b896
            },
            DESERT_COLD: {
                name: "Cold Desert",
                color: 0xa0a080,
                icon: "üèîÔ∏è",
                temp: "-10¬∞C",
                treeTypes: ['shrub', 'sage'],
                treeColors: [0x808060, 0x6b8e6b],
                treeDensity: 0.1,
                animals: ['gazelle', 'wild_horse', 'eagle'],
                animalColors: [0xd2b48c, 0x3d2914, 0x4a3728],
                flowers: [],
                flowerColors: [],
                groundColor: 0xb0a890
            },
            SAVANNA: {
                name: "Savanna",
                color: 0xbdb76b,
                icon: "ü¶Å",
                temp: "25¬∞C",
                treeTypes: ['acacia', 'baobab'],
                treeColors: [0x6b8e23, 0x556b2f, 0x8b7355],
                treeDensity: 0.3,
                animals: ['lion', 'elephant', 'giraffe', 'zebra', 'rhino', 'gazelle'],
                animalColors: [0xd4a574, 0x808080, 0xffd700, 0xffffff, 0x696969],
                flowers: ['grass_flower'],
                flowerColors: [0xffd700, 0xff6347],
                groundColor: 0xc9b458
            },
            GRASSLAND: {
                name: "Grassland / Prairie",
                color: 0x9acd32,
                icon: "üåæ",
                temp: "15¬∞C",
                treeTypes: ['grass_tree'],
                treeColors: [0x7cba3d, 0x90c040],
                treeDensity: 0.25,
                animals: ['bison', 'prairie_dog', 'coyote', 'hawk'],
                animalColors: [0x3d2914, 0xd2b48c, 0x808080],
                flowers: ['sunflower', 'wildflower'],
                flowerColors: [0xffd700, 0xff69b4, 0x9370db, 0xffffff],
                groundColor: 0xa8c050
            },
            MEDITERRANEAN: {
                name: "Mediterranean",
                color: 0x6b8e23,
                icon: "ü´í",
                temp: "18¬∞C",
                treeTypes: ['olive', 'cypress', 'cork_oak'],
                treeColors: [0x556b2f, 0x2f4f4f, 0x6b8e23],
                treeDensity: 0.5,
                animals: ['goat', 'rabbit', 'gecko'],
                animalColors: [0xffffff, 0xd2b48c, 0x228b22],
                flowers: ['lavender', 'poppy'],
                flowerColors: [0x9370db, 0xff4500, 0xffd700],
                groundColor: 0x7a9a40
            },
            MOUNTAIN: {
                name: "Mountain / Alpine",
                color: 0x696969,
                icon: "‚õ∞Ô∏è",
                temp: "-8¬∞C",
                treeTypes: ['pine_alpine', 'fir'],
                treeColors: [0x1a4a1a, 0x0a3a0a],
                treeDensity: 0.4,
                animals: ['mountain_goat', 'snow_leopard', 'eagle', 'marmot'],
                animalColors: [0xffffff, 0xc0c0c0, 0x3d2914],
                flowers: ['edelweiss', 'alpine_rose'],
                flowerColors: [0xffffff, 0xff69b4],
                groundColor: 0x606060,
                hasSnow: true
            },
            ICE_SHEET: {
                name: "Ice Sheet / Polar",
                color: 0xf0f8ff,
                icon: "üßä",
                temp: "-50¬∞C",
                treeTypes: [],
                treeColors: [],
                treeDensity: 0,
                animals: ['penguin', 'polar_bear', 'seal', 'arctic_tern'],
                animalColors: [0x000000, 0xffffff, 0x808080],
                flowers: [],
                flowerColors: [],
                groundColor: 0xffffff,
                hasSnow: true
            },
            WETLAND: {
                name: "Wetland / Swamp",
                color: 0x2f4f4f,
                icon: "üêä",
                temp: "22¬∞C",
                treeTypes: ['mangrove', 'cypress_swamp', 'willow'],
                treeColors: [0x2f4f2f, 0x3d5c3d, 0x4a6b4a],
                treeDensity: 0.8,
                animals: ['alligator', 'heron', 'frog', 'turtle', 'snake'],
                animalColors: [0x2f4f2f, 0xffffff, 0x228b22, 0x556b2f],
                flowers: ['water_lily', 'lotus'],
                flowerColors: [0xffffff, 0xff69b4, 0xffff00],
                groundColor: 0x3a5a3a
            }
        };

        // ============ BIOME REGIONS (Real World Locations) ============
        const BIOME_REGIONS = [
            // TROPICAL RAINFORESTS
            { biome: 'TROPICAL_RAINFOREST', name: "Amazon Basin", lat: -3, lng: -60, radius: 20, desc: "World's largest rainforest, home to 10% of all species on Earth" },
            { biome: 'TROPICAL_RAINFOREST', name: "Congo Rainforest", lat: 0, lng: 22, radius: 15, desc: "Africa's largest rainforest, second only to the Amazon" },
            { biome: 'TROPICAL_RAINFOREST', name: "Southeast Asian Rainforest", lat: 2, lng: 110, radius: 12, desc: "Ancient rainforests of Borneo, Sumatra, and Malaysia" },
            { biome: 'TROPICAL_RAINFOREST', name: "Central American Rainforest", lat: 10, lng: -84, radius: 8, desc: "Biodiversity hotspot connecting North and South America" },
            { biome: 'TROPICAL_RAINFOREST', name: "Papua New Guinea", lat: -5, lng: 145, radius: 8, desc: "One of the most biodiverse places on Earth" },
            { biome: 'TROPICAL_RAINFOREST', name: "Madagascar Rainforest", lat: -18, lng: 48, radius: 6, desc: "Unique island ecosystem with 90% endemic species" },

            // TEMPERATE FORESTS
            { biome: 'TEMPERATE_FOREST', name: "Pacific Northwest", lat: 47, lng: -122, radius: 10, desc: "Ancient temperate rainforests with towering conifers" },
            { biome: 'TEMPERATE_FOREST', name: "Eastern US Forest", lat: 38, lng: -80, radius: 15, desc: "Appalachian deciduous forests with stunning fall colors" },
            { biome: 'TEMPERATE_FOREST', name: "Western European Forest", lat: 48, lng: 8, radius: 12, desc: "Historic woodlands of Germany, France, and the Alps" },
            { biome: 'TEMPERATE_FOREST', name: "British Isles", lat: 54, lng: -2, radius: 8, desc: "Ancient oak and beech forests" },
            { biome: 'TEMPERATE_FOREST', name: "Japanese Forest", lat: 36, lng: 138, radius: 8, desc: "Home to cherry blossoms and Japanese maple" },
            { biome: 'TEMPERATE_FOREST', name: "Chilean Valdivian", lat: -40, lng: -73, radius: 8, desc: "South America's temperate rainforest" },
            { biome: 'TEMPERATE_FOREST', name: "New Zealand Forest", lat: -42, lng: 172, radius: 6, desc: "Ancient forests with giant ferns and kauri trees" },
            { biome: 'TEMPERATE_FOREST', name: "Southeast Australia", lat: -37, lng: 147, radius: 8, desc: "Eucalyptus forests and temperate woodlands" },
            { biome: 'TEMPERATE_FOREST', name: "Korean Peninsula", lat: 37, lng: 128, radius: 6, desc: "Mixed deciduous and coniferous forests" },

            // BOREAL / TAIGA
            { biome: 'BOREAL_TAIGA', name: "Canadian Boreal", lat: 58, lng: -100, radius: 25, desc: "World's largest intact forest ecosystem" },
            { biome: 'BOREAL_TAIGA', name: "Siberian Taiga", lat: 62, lng: 100, radius: 30, desc: "Largest terrestrial biome, spanning Russia" },
            { biome: 'BOREAL_TAIGA', name: "Scandinavian Taiga", lat: 64, lng: 20, radius: 12, desc: "Northern forests of Norway, Sweden, Finland" },
            { biome: 'BOREAL_TAIGA', name: "Alaska Boreal", lat: 64, lng: -150, radius: 15, desc: "Vast wilderness of spruce and birch" },

            // TUNDRA
            { biome: 'TUNDRA', name: "Arctic Tundra Canada", lat: 72, lng: -95, radius: 18, desc: "Treeless plains with permafrost" },
            { biome: 'TUNDRA', name: "Siberian Tundra", lat: 72, lng: 130, radius: 20, desc: "Vast frozen plains of northern Russia" },
            { biome: 'TUNDRA', name: "Scandinavian Tundra", lat: 70, lng: 25, radius: 8, desc: "Arctic Norway and northern Finland" },
            { biome: 'TUNDRA', name: "Greenland Coast", lat: 72, lng: -40, radius: 12, desc: "Coastal tundra around the ice sheet" },
            { biome: 'TUNDRA', name: "Patagonian Steppe", lat: -50, lng: -70, radius: 10, desc: "Cold windswept plains of southern Argentina" },

            // HOT DESERTS
            { biome: 'DESERT_HOT', name: "Sahara Desert", lat: 24, lng: 10, radius: 28, desc: "World's largest hot desert, size of the USA" },
            { biome: 'DESERT_HOT', name: "Arabian Desert", lat: 23, lng: 50, radius: 15, desc: "Sandy deserts of the Arabian Peninsula" },
            { biome: 'DESERT_HOT', name: "Sonoran Desert", lat: 32, lng: -112, radius: 8, desc: "Home to the iconic saguaro cactus" },
            { biome: 'DESERT_HOT', name: "Mojave Desert", lat: 35, lng: -116, radius: 6, desc: "Including Death Valley, hottest place on Earth" },
            { biome: 'DESERT_HOT', name: "Australian Outback", lat: -24, lng: 135, radius: 20, desc: "Red desert heart of Australia" },
            { biome: 'DESERT_HOT', name: "Kalahari Desert", lat: -24, lng: 22, radius: 12, desc: "Southern African semi-arid savanna" },
            { biome: 'DESERT_HOT', name: "Thar Desert", lat: 27, lng: 71, radius: 8, desc: "The Great Indian Desert" },
            { biome: 'DESERT_HOT', name: "Atacama Desert", lat: -24, lng: -69, radius: 6, desc: "Driest place on Earth" },

            // COLD DESERTS
            { biome: 'DESERT_COLD', name: "Gobi Desert", lat: 43, lng: 105, radius: 15, desc: "Cold desert spanning Mongolia and China" },
            { biome: 'DESERT_COLD', name: "Great Basin Desert", lat: 40, lng: -117, radius: 10, desc: "High altitude cold desert of Nevada/Utah" },
            { biome: 'DESERT_COLD', name: "Patagonian Desert", lat: -46, lng: -68, radius: 10, desc: "Cold desert of southern Argentina" },
            { biome: 'DESERT_COLD', name: "Karakum Desert", lat: 40, lng: 58, radius: 10, desc: "Black Sand desert of Central Asia" },

            // SAVANNAS
            { biome: 'SAVANNA', name: "Serengeti", lat: -3, lng: 35, radius: 10, desc: "Famous for the great wildebeest migration" },
            { biome: 'SAVANNA', name: "East African Savanna", lat: 0, lng: 38, radius: 15, desc: "Home to the Big Five safari animals" },
            { biome: 'SAVANNA', name: "Brazilian Cerrado", lat: -15, lng: -48, radius: 15, desc: "World's most biodiverse savanna" },
            { biome: 'SAVANNA', name: "Australian Savanna", lat: -16, lng: 135, radius: 15, desc: "Tropical woodlands of northern Australia" },
            { biome: 'SAVANNA', name: "Llanos", lat: 7, lng: -68, radius: 10, desc: "Tropical grasslands of Venezuela/Colombia" },
            { biome: 'SAVANNA', name: "West African Savanna", lat: 12, lng: 0, radius: 18, desc: "Sahel transition zone" },

            // GRASSLANDS
            { biome: 'GRASSLAND', name: "North American Prairie", lat: 42, lng: -100, radius: 18, desc: "Great Plains, once home to 60 million bison" },
            { biome: 'GRASSLAND', name: "Eurasian Steppe", lat: 48, lng: 65, radius: 25, desc: "Vast grasslands from Ukraine to Mongolia" },
            { biome: 'GRASSLAND', name: "Pampas", lat: -35, lng: -62, radius: 12, desc: "Fertile grasslands of Argentina" },
            { biome: 'GRASSLAND', name: "South African Veld", lat: -29, lng: 27, radius: 10, desc: "Highland grasslands of South Africa" },

            // MEDITERRANEAN
            { biome: 'MEDITERRANEAN', name: "Mediterranean Basin", lat: 38, lng: 15, radius: 12, desc: "Olive groves and vineyards around the Med" },
            { biome: 'MEDITERRANEAN', name: "California Chaparral", lat: 35, lng: -119, radius: 8, desc: "Shrublands of coastal California" },
            { biome: 'MEDITERRANEAN', name: "Chilean Matorral", lat: -33, lng: -71, radius: 6, desc: "Mediterranean climate of central Chile" },
            { biome: 'MEDITERRANEAN', name: "Western Australia", lat: -33, lng: 117, radius: 6, desc: "Unique Mediterranean flora of SW Australia" },
            { biome: 'MEDITERRANEAN', name: "South African Fynbos", lat: -34, lng: 19, radius: 5, desc: "Extraordinarily diverse Cape flora" },

            // MOUNTAINS
            { biome: 'MOUNTAIN', name: "Himalayas", lat: 28, lng: 85, radius: 15, desc: "World's highest peaks including Everest" },
            { biome: 'MOUNTAIN', name: "Rocky Mountains", lat: 45, lng: -110, radius: 12, desc: "North America's great spine" },
            { biome: 'MOUNTAIN', name: "European Alps", lat: 46, lng: 10, radius: 8, desc: "Iconic peaks of central Europe" },
            { biome: 'MOUNTAIN', name: "Andes Mountains", lat: -15, lng: -72, radius: 12, desc: "World's longest mountain range" },
            { biome: 'MOUNTAIN', name: "Southern Andes", lat: -42, lng: -72, radius: 8, desc: "Patagonian ice fields and peaks" },
            { biome: 'MOUNTAIN', name: "Caucasus", lat: 43, lng: 44, radius: 6, desc: "Mountains between Europe and Asia" },
            { biome: 'MOUNTAIN', name: "Atlas Mountains", lat: 31, lng: -6, radius: 6, desc: "North African mountain range" },
            { biome: 'MOUNTAIN', name: "Japanese Alps", lat: 36, lng: 138, radius: 5, desc: "Snow-capped peaks of Honshu" },
            { biome: 'MOUNTAIN', name: "New Zealand Alps", lat: -43, lng: 170, radius: 5, desc: "Southern Alps of South Island" },
            { biome: 'MOUNTAIN', name: "Ethiopian Highlands", lat: 9, lng: 39, radius: 8, desc: "Roof of Africa" },
            { biome: 'MOUNTAIN', name: "Tibetan Plateau", lat: 33, lng: 90, radius: 18, desc: "World's highest and largest plateau" },

            // ICE SHEETS
            { biome: 'ICE_SHEET', name: "Antarctica", lat: -82, lng: 0, radius: 30, desc: "Coldest, driest, windiest continent" },
            { biome: 'ICE_SHEET', name: "Greenland Ice Sheet", lat: 75, lng: -42, radius: 18, desc: "Second largest ice body on Earth" },
            { biome: 'ICE_SHEET', name: "Arctic Sea Ice", lat: 85, lng: 0, radius: 20, desc: "Polar bear and seal habitat" },

            // WETLANDS
            { biome: 'WETLAND', name: "Everglades", lat: 26, lng: -81, radius: 6, desc: "River of grass, home to alligators" },
            { biome: 'WETLAND', name: "Pantanal", lat: -18, lng: -57, radius: 10, desc: "World's largest tropical wetland" },
            { biome: 'WETLAND', name: "Okavango Delta", lat: -19, lng: 23, radius: 8, desc: "Inland delta, Africa's last Eden" },
            { biome: 'WETLAND', name: "Sundarbans", lat: 22, lng: 89, radius: 6, desc: "Largest mangrove forest, Bengal tigers" },
            { biome: 'WETLAND', name: "Mekong Delta", lat: 10, lng: 106, radius: 5, desc: "Rice paddies and river systems" },
            { biome: 'WETLAND', name: "Mississippi Delta", lat: 30, lng: -90, radius: 5, desc: "Bayous and swamplands of Louisiana" },
        ];

        // ============ SCENE SETUP ============
        let scene, camera, renderer;
        let earth, clouds, nightLights, atmosphere;
        let allObjects = { trees: [], houses: [], animals: [], flowers: [], agents: [] };
        let biomeGroups = {};
        let regionData = [];
        
        let time = 0;
        let autoRotate = true;
        let showClouds = true;
        let showLife = true;
        let isNight = false;
        let showLabels = false;
        
        let isDragging = false;
        let prevMouse = { x: 0, y: 0 };
        let spherical = { theta: 0, phi: Math.PI / 3, radius: 260 };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000005);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 3000);
            updateCamera();

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.1;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            loadTextures();

            window.addEventListener('resize', onResize);
            renderer.domElement.addEventListener('mousedown', e => { isDragging = true; prevMouse = { x: e.clientX, y: e.clientY }; });
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mouseup', () => isDragging = false);
            renderer.domElement.addEventListener('wheel', e => {
                spherical.radius = Math.max(130, Math.min(450, spherical.radius + e.deltaY * 0.2));
                updateCamera();
            });
            renderer.domElement.addEventListener('click', onClick);
            
            // Touch
            renderer.domElement.addEventListener('touchstart', e => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                e.preventDefault();
            }, { passive: false });
            renderer.domElement.addEventListener('touchmove', e => {
                if (!isDragging) return;
                const dx = e.touches[0].clientX - prevMouse.x;
                const dy = e.touches[0].clientY - prevMouse.y;
                spherical.theta -= dx * 0.005;
                spherical.phi = Math.max(0.2, Math.min(Math.PI - 0.2, spherical.phi + dy * 0.005));
                updateCamera();
                prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                e.preventDefault();
            }, { passive: false });
            renderer.domElement.addEventListener('touchend', () => isDragging = false);

            document.getElementById('btnRotate').addEventListener('click', () => { autoRotate = !autoRotate; document.getElementById('btnRotate').classList.toggle('active', autoRotate); });
            document.getElementById('btnClouds').addEventListener('click', () => { showClouds = !showClouds; clouds.visible = showClouds; document.getElementById('btnClouds').classList.toggle('active', showClouds); });
            document.getElementById('btnLife').addEventListener('click', toggleLife);
            document.getElementById('btnNight').addEventListener('click', toggleNight);
            document.getElementById('btnLabels').addEventListener('click', () => { showLabels = !showLabels; document.getElementById('btnLabels').classList.toggle('active', showLabels); });
        }

        function loadTextures() {
            const mgr = new THREE.LoadingManager();
            mgr.onProgress = (_, loaded, total) => {
                document.getElementById('loadingProgress').style.width = (loaded / total * 40) + '%';
            };
            mgr.onLoad = createWorld;

            const loader = new THREE.TextureLoader(mgr);
            window.textures = {
                earth: loader.load(TEXTURES.earth),
                bump: loader.load(TEXTURES.bump),
                specular: loader.load(TEXTURES.specular),
                clouds: loader.load(TEXTURES.clouds),
                night: loader.load(TEXTURES.night)
            };
        }

        function createWorld() {
            createStars();
            createLights();
            createEarth();
            createClouds();
            createAtmosphere();
            populateAllBiomes();
            buildBiomeUI();
            updateCounts();

            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                animate();
            }, 400);
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(6000 * 3);
            for (let i = 0; i < 6000; i++) {
                const r = 800 + Math.random() * 1500;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(Math.random() * 2 - 1);
                pos[i * 3] = r * Math.sin(phi) * Math.cos(theta);
                pos[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
                pos[i * 3 + 2] = r * Math.cos(phi);
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            scene.add(new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xffffff, size: 1 })));
        }

        function createLights() {
            window.sunLight = new THREE.DirectionalLight(0xffffff, 1.3);
            window.sunLight.position.set(350, 150, 350);
            scene.add(window.sunLight);
            window.ambientLight = new THREE.AmbientLight(0x404060, 0.4);
            scene.add(window.ambientLight);
            scene.add(new THREE.HemisphereLight(0x88aaff, 0x444422, 0.25));
        }

        function createEarth() {
            const geo = new THREE.SphereGeometry(EARTH_RADIUS, 128, 128);
            earth = new THREE.Mesh(geo, new THREE.MeshPhongMaterial({
                map: window.textures.earth,
                bumpMap: window.textures.bump,
                bumpScale: 0.4,
                specularMap: window.textures.specular,
                specular: new THREE.Color(0x111111),
                shininess: 5
            }));
            scene.add(earth);

            nightLights = new THREE.Mesh(geo.clone(), new THREE.MeshBasicMaterial({
                map: window.textures.night,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0
            }));
            nightLights.scale.setScalar(1.001);
            scene.add(nightLights);
        }

        function createClouds() {
            clouds = new THREE.Mesh(
                new THREE.SphereGeometry(EARTH_RADIUS + 1.2, 64, 64),
                new THREE.MeshPhongMaterial({ map: window.textures.clouds, transparent: true, opacity: 0.3, depthWrite: false })
            );
            scene.add(clouds);
        }

        function createAtmosphere() {
            atmosphere = new THREE.Mesh(
                new THREE.SphereGeometry(EARTH_RADIUS + 10, 64, 64),
                new THREE.ShaderMaterial({
                    vertexShader: `varying vec3 vNormal; void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
                    fragmentShader: `varying vec3 vNormal; void main() { float i = pow(0.65 - dot(vNormal, vec3(0,0,1)), 2.0); gl_FragColor = vec4(0.3, 0.6, 1.0, i * 0.4); }`,
                    blending: THREE.AdditiveBlending,
                    side: THREE.BackSide,
                    transparent: true,
                    depthWrite: false
                })
            );
            scene.add(atmosphere);
        }

        // ============ POPULATE BIOMES ============
        function populateAllBiomes() {
            let totalRegions = BIOME_REGIONS.length;
            let processed = 0;

            BIOME_REGIONS.forEach((region, idx) => {
                const biome = BIOMES[region.biome];
                if (!biomeGroups[region.biome]) biomeGroups[region.biome] = [];

                const regionGroup = new THREE.Group();
                regionGroup.userData = { ...region, biome: biome };
                
                const counts = { trees: 0, houses: 0, animals: 0, flowers: 0, agents: 0 };
                
                // Scale by region size
                const scale = region.radius / 15;
                const treesCount = Math.floor(biome.treeDensity * 40 * scale);
                const housesCount = Math.floor(8 * scale);
                const animalsCount = Math.floor(15 * scale);
                const flowersCount = Math.floor(biome.flowerColors.length > 0 ? 30 * scale : 0);
                const agentsCount = Math.floor(3 * scale);

                // Trees
                for (let i = 0; i < treesCount; i++) {
                    const tree = createBiomeTree(biome);
                    placeOnRegion(tree, region);
                    allObjects.trees.push(tree);
                    regionGroup.add(tree);
                    counts.trees++;
                }

                // Houses (fewer in harsh biomes)
                const houseMultiplier = ['ICE_SHEET', 'TUNDRA', 'DESERT_HOT'].includes(region.biome) ? 0.2 : 1;
                for (let i = 0; i < housesCount * houseMultiplier; i++) {
                    const house = createBiomeHouse(biome);
                    placeOnRegion(house, region);
                    allObjects.houses.push(house);
                    regionGroup.add(house);
                    counts.houses++;
                }

                // Animals
                for (let i = 0; i < animalsCount; i++) {
                    const animal = createBiomeAnimal(biome);
                    placeOnRegion(animal, region);
                    animal.userData.region = region;
                    allObjects.animals.push(animal);
                    regionGroup.add(animal);
                    counts.animals++;
                }

                // Flowers
                for (let i = 0; i < flowersCount; i++) {
                    const flower = createBiomeFlower(biome);
                    placeOnRegion(flower, region);
                    allObjects.flowers.push(flower);
                    regionGroup.add(flower);
                    counts.flowers++;
                }

                // Agents
                for (let i = 0; i < agentsCount; i++) {
                    const agent = createAgent();
                    placeOnRegion(agent, region, 2);
                    agent.userData.region = region;
                    allObjects.agents.push(agent);
                    regionGroup.add(agent);
                    counts.agents++;
                }

                regionGroup.userData.counts = counts;
                regionData.push(regionGroup.userData);
                biomeGroups[region.biome].push(regionGroup);
                scene.add(regionGroup);

                processed++;
                document.getElementById('loadingProgress').style.width = (40 + processed / totalRegions * 60) + '%';
            });
        }

        function placeOnRegion(obj, region, heightOffset = 0) {
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.random() * region.radius * 0.8;
            const lat = region.lat + Math.cos(angle) * dist * 0.5;
            const lng = region.lng + Math.sin(angle) * dist * 0.7;
            const pos = latLngToVec3(lat, lng, EARTH_RADIUS + 0.3 + heightOffset);
            obj.position.copy(pos);
            const normal = pos.clone().normalize();
            obj.lookAt(pos.clone().add(normal));
            obj.rotateX(Math.PI / 2);
            obj.rotateY(Math.random() * Math.PI * 2);
            obj.userData.lat = lat;
            obj.userData.lng = lng;
        }

        function latLngToVec3(lat, lng, r) {
            const phi = (90 - lat) * Math.PI / 180;
            const theta = (lng + 180) * Math.PI / 180;
            return new THREE.Vector3(r * Math.sin(phi) * Math.cos(theta), r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta));
        }

        // ============ BIOME-SPECIFIC CREATORS ============
        function createBiomeTree(biome) {
            const group = new THREE.Group();
            if (biome.treeTypes.length === 0) return group;

            const type = biome.treeTypes[Math.floor(Math.random() * biome.treeTypes.length)];
            const leafColor = biome.treeColors[Math.floor(Math.random() * biome.treeColors.length)];
            const trunkMat = new THREE.MeshLambertMaterial({ color: 0x4a3728 });
            const leafMat = new THREE.MeshLambertMaterial({ color: leafColor });

            if (type === 'cactus') {
                // Saguaro cactus
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.2, 2, 8), new THREE.MeshLambertMaterial({ color: 0x228b22 }));
                trunk.position.y = 1;
                group.add(trunk);
                // Arms
                [-0.4, 0.4].forEach((x, i) => {
                    const arm = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.1, 0.8, 6), new THREE.MeshLambertMaterial({ color: 0x228b22 }));
                    arm.position.set(x, 1.2 + i * 0.3, 0);
                    arm.rotation.z = x > 0 ? -0.5 : 0.5;
                    group.add(arm);
                });
            } else if (type === 'palm' || type === 'palm_desert') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.15, 2.5, 6), trunkMat);
                trunk.position.y = 1.25;
                group.add(trunk);
                for (let i = 0; i < 7; i++) {
                    const frond = new THREE.Mesh(new THREE.ConeGeometry(0.1, 1.8, 3), new THREE.MeshLambertMaterial({ color: 0x228b22 }));
                    frond.position.y = 2.6;
                    frond.rotation.z = Math.PI / 3;
                    frond.rotation.y = (i / 7) * Math.PI * 2;
                    group.add(frond);
                }
            } else if (type === 'spruce' || type === 'fir' || type === 'pine' || type === 'pine_alpine') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.18, 1.5, 6), trunkMat);
                trunk.position.y = 0.75;
                group.add(trunk);
                for (let i = 0; i < 5; i++) {
                    const cone = new THREE.Mesh(new THREE.ConeGeometry(1 - i * 0.15, 1, 6), leafMat);
                    cone.position.y = 1.5 + i * 0.7;
                    group.add(cone);
                }
            } else if (type === 'acacia') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.15, 2, 6), trunkMat);
                trunk.position.y = 1;
                trunk.rotation.z = 0.1;
                group.add(trunk);
                const canopy = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 0.3, 8), leafMat);
                canopy.position.y = 2.2;
                group.add(canopy);
            } else if (type === 'baobab') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.7, 2, 8), trunkMat);
                trunk.position.y = 1;
                group.add(trunk);
                const top = new THREE.Mesh(new THREE.SphereGeometry(0.8, 8, 8), leafMat);
                top.position.y = 2.3;
                top.scale.y = 0.5;
                group.add(top);
            } else if (type === 'shrub' || type === 'sage') {
                const bush = new THREE.Mesh(new THREE.SphereGeometry(0.4, 6, 6), leafMat);
                bush.position.y = 0.3;
                bush.scale.y = 0.6;
                group.add(bush);
            } else if (type === 'mangrove' || type === 'cypress_swamp') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.2, 1.5, 6), trunkMat);
                trunk.position.y = 0.75;
                group.add(trunk);
                // Roots
                for (let i = 0; i < 5; i++) {
                    const root = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.05, 0.6, 4), trunkMat);
                    root.position.set(Math.cos(i) * 0.3, 0.2, Math.sin(i) * 0.3);
                    root.rotation.z = 0.5;
                    root.rotation.y = (i / 5) * Math.PI * 2;
                    group.add(root);
                }
                const leaves = new THREE.Mesh(new THREE.SphereGeometry(0.8, 6, 6), leafMat);
                leaves.position.y = 1.8;
                group.add(leaves);
            } else if (type === 'giant' || type === 'tropical') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.35, 3, 8), trunkMat);
                trunk.position.y = 1.5;
                group.add(trunk);
                const canopy = new THREE.Mesh(new THREE.IcosahedronGeometry(1.5, 1), leafMat);
                canopy.position.y = 3.5;
                group.add(canopy);
            } else {
                // Default oak/maple style
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.2, 1.5, 6), trunkMat);
                trunk.position.y = 0.75;
                group.add(trunk);
                const leaves = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 0), leafMat);
                leaves.position.y = 2;
                group.add(leaves);
            }

            group.scale.setScalar(0.35 + Math.random() * 0.25);
            group.userData = { type: 'tree', sway: Math.random() * Math.PI * 2 };
            return group;
        }

        function createBiomeHouse(biome) {
            const group = new THREE.Group();
            
            // Style based on biome
            let wallColor = 0xfaf8f5;
            let roofColor = 0xc44;
            let style = 'normal';

            if (biome.name.includes('Desert')) {
                wallColor = 0xf5deb3;
                roofColor = 0xdaa520;
                style = 'adobe';
            } else if (biome.name.includes('Tundra') || biome.name.includes('Ice') || biome.name.includes('Boreal')) {
                wallColor = 0xe8e8e8;
                roofColor = 0x2f4f4f;
                style = 'cabin';
            } else if (biome.name.includes('Tropical')) {
                wallColor = 0xdeb887;
                roofColor = 0x228b22;
                style = 'hut';
            } else if (biome.name.includes('Savanna')) {
                wallColor = 0xd2b48c;
                roofColor = 0xdaa520;
                style = 'hut';
            } else if (biome.name.includes('Mediterranean')) {
                wallColor = 0xfffaf0;
                roofColor = 0xcd853f;
                style = 'villa';
            }

            if (style === 'hut') {
                const base = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.7, 0.8, 8), new THREE.MeshLambertMaterial({ color: wallColor }));
                base.position.y = 0.4;
                group.add(base);
                const roof = new THREE.Mesh(new THREE.ConeGeometry(0.9, 0.8, 8), new THREE.MeshLambertMaterial({ color: roofColor }));
                roof.position.y = 1.2;
                group.add(roof);
            } else if (style === 'adobe') {
                const base = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.8, 1.2), new THREE.MeshLambertMaterial({ color: wallColor }));
                base.position.y = 0.4;
                group.add(base);
                const roof = new THREE.Mesh(new THREE.BoxGeometry(1.3, 0.1, 1.3), new THREE.MeshLambertMaterial({ color: roofColor }));
                roof.position.y = 0.85;
                group.add(roof);
            } else {
                const walls = new THREE.Mesh(new THREE.BoxGeometry(1, 0.9, 1), new THREE.MeshLambertMaterial({ color: wallColor }));
                walls.position.y = 0.45;
                group.add(walls);
                const roof = new THREE.Mesh(new THREE.ConeGeometry(0.9, 0.6, 4), new THREE.MeshLambertMaterial({ color: roofColor }));
                roof.position.y = 1.2;
                roof.rotation.y = Math.PI / 4;
                group.add(roof);
            }

            // Door
            const door = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.4, 0.05), new THREE.MeshLambertMaterial({ color: 0x4a3728 }));
            door.position.set(0, 0.25, 0.53);
            group.add(door);

            group.scale.setScalar(0.4 + Math.random() * 0.2);
            group.userData = { type: 'house' };
            return group;
        }

        function createBiomeAnimal(biome) {
            const group = new THREE.Group();
            const color = biome.animalColors[Math.floor(Math.random() * biome.animalColors.length)] || 0x808080;
            const mat = new THREE.MeshLambertMaterial({ color });

            // Different shapes for different biomes
            let scale = 1;
            if (biome.name.includes('Ice') || biome.name.includes('Polar')) {
                // Penguin shape - using cylinder + spheres since CapsuleGeometry not in r128
                const bodyMid = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.3, 8), new THREE.MeshLambertMaterial({ color: 0x111111 }));
                bodyMid.position.y = 0.3;
                group.add(bodyMid);
                const bodyTop = new THREE.Mesh(new THREE.SphereGeometry(0.15, 8, 8), new THREE.MeshLambertMaterial({ color: 0x111111 }));
                bodyTop.position.y = 0.45;
                group.add(bodyTop);
                const bodyBot = new THREE.Mesh(new THREE.SphereGeometry(0.15, 8, 8), new THREE.MeshLambertMaterial({ color: 0x111111 }));
                bodyBot.position.y = 0.15;
                group.add(bodyBot);
                const belly = new THREE.Mesh(new THREE.SphereGeometry(0.12, 8, 8), new THREE.MeshLambertMaterial({ color: 0xffffff }));
                belly.position.set(0, 0.25, 0.08);
                group.add(belly);
                scale = 0.8;
            } else if (biome.name.includes('Savanna')) {
                // Larger animals
                const body = new THREE.Mesh(new THREE.SphereGeometry(0.3, 8, 8), mat);
                body.scale.set(1, 0.8, 1.4);
                group.add(body);
                const head = new THREE.Mesh(new THREE.SphereGeometry(0.15, 8, 8), mat);
                head.position.set(0, 0.1, 0.35);
                group.add(head);
                // Legs
                for (let i = 0; i < 4; i++) {
                    const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.4, 4), mat);
                    leg.position.set((i % 2 === 0 ? -0.12 : 0.12), -0.25, (i < 2 ? 0.15 : -0.15));
                    group.add(leg);
                }
                scale = 1.2;
            } else {
                // Default small animal
                const body = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), mat);
                body.scale.set(1, 0.7, 1.2);
                group.add(body);
                const head = new THREE.Mesh(new THREE.SphereGeometry(0.12, 8, 8), mat);
                head.position.set(0, 0.1, 0.2);
                group.add(head);
                // Eyes
                const eyeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                [[-0.04, 0.14, 0.28], [0.04, 0.14, 0.28]].forEach(([x, y, z]) => {
                    const eye = new THREE.Mesh(new THREE.SphereGeometry(0.025, 6, 6), eyeMat);
                    eye.position.set(x, y, z);
                    group.add(eye);
                });
                // Ears
                [[-0.06, 0.22, 0.15], [0.06, 0.22, 0.15]].forEach(([x, y, z]) => {
                    const ear = new THREE.Mesh(new THREE.ConeGeometry(0.04, 0.1, 4), mat);
                    ear.position.set(x, y, z);
                    group.add(ear);
                });
            }

            group.scale.setScalar((0.25 + Math.random() * 0.15) * scale);
            group.userData = { type: 'animal', hop: Math.random() * Math.PI * 2, wanderAngle: Math.random() * Math.PI * 2, speed: 0.0002 + Math.random() * 0.0002 };
            return group;
        }

        function createBiomeFlower(biome) {
            const group = new THREE.Group();
            if (biome.flowerColors.length === 0) return group;

            const color = biome.flowerColors[Math.floor(Math.random() * biome.flowerColors.length)];
            
            // Stem
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.015, 0.015, 0.3, 4), new THREE.MeshLambertMaterial({ color: 0x228b22 }));
            stem.position.y = 0.15;
            group.add(stem);

            // Petals
            const petalMat = new THREE.MeshLambertMaterial({ color });
            for (let i = 0; i < 5; i++) {
                const petal = new THREE.Mesh(new THREE.SphereGeometry(0.06, 6, 6), petalMat);
                petal.scale.set(1, 0.3, 0.5);
                const angle = (i / 5) * Math.PI * 2;
                petal.position.set(Math.cos(angle) * 0.06, 0.3, Math.sin(angle) * 0.06);
                petal.rotation.y = angle;
                petal.rotation.z = 0.3;
                group.add(petal);
            }

            // Center
            const center = new THREE.Mesh(new THREE.SphereGeometry(0.035, 6, 6), new THREE.MeshLambertMaterial({ color: 0xffd700 }));
            center.position.y = 0.3;
            group.add(center);

            group.scale.setScalar(0.4 + Math.random() * 0.3);
            group.userData = { type: 'flower', sway: Math.random() * Math.PI * 2 };
            return group;
        }

        function createAgent() {
            const group = new THREE.Group();
            const colors = [0xff1d6c, 0x2979ff, 0xf5a623, 0x9c27b0];
            const color = colors[Math.floor(Math.random() * colors.length)];

            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.16, 0.35, 8), new THREE.MeshLambertMaterial({ color }));
            body.position.y = 0.18;
            group.add(body);

            const head = new THREE.Mesh(new THREE.SphereGeometry(0.14, 12, 12), new THREE.MeshLambertMaterial({ color: 0xffffff }));
            head.position.y = 0.48;
            group.add(head);

            const eye = new THREE.Mesh(new THREE.CircleGeometry(0.06, 12), new THREE.MeshBasicMaterial({ color: 0xff1d6c }));
            eye.position.set(0, 0.5, 0.12);
            group.add(eye);

            const pupil = new THREE.Mesh(new THREE.CircleGeometry(0.025, 8), new THREE.MeshBasicMaterial({ color: 0x000000 }));
            pupil.position.set(0, 0.5, 0.125);
            group.add(pupil);

            const ring = new THREE.Mesh(new THREE.TorusGeometry(0.18, 0.015, 6, 20), new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.4 }));
            ring.rotation.x = Math.PI / 2;
            ring.position.y = 0.02;
            group.add(ring);

            group.scale.setScalar(0.5);
            group.userData = { type: 'agent', hover: Math.random() * Math.PI * 2, wanderAngle: Math.random() * Math.PI * 2, speed: 0.0003 + Math.random() * 0.0002 };
            return group;
        }

        // ============ UI ============
        function buildBiomeUI() {
            const list = document.getElementById('biomeList');
            const biomeCounts = {};
            
            BIOME_REGIONS.forEach(r => {
                if (!biomeCounts[r.biome]) biomeCounts[r.biome] = 0;
                biomeCounts[r.biome]++;
            });

            Object.entries(BIOMES).forEach(([key, biome]) => {
                if (!biomeCounts[key]) return;
                const item = document.createElement('div');
                item.className = 'biome-item';
                item.innerHTML = `
                    <div class="biome-dot" style="background: #${biome.color.toString(16).padStart(6, '0')}"></div>
                    <span>${biome.icon} ${biome.name}</span>
                    <span class="biome-count">${biomeCounts[key]}</span>
                `;
                list.appendChild(item);
            });
        }

        function updateCounts() {
            document.getElementById('treeCount').textContent = allObjects.trees.length.toLocaleString();
            document.getElementById('houseCount').textContent = allObjects.houses.length.toLocaleString();
            document.getElementById('animalCount').textContent = allObjects.animals.length.toLocaleString();
            document.getElementById('agentCount').textContent = allObjects.agents.length.toLocaleString();
            document.getElementById('flowerCount').textContent = allObjects.flowers.length.toLocaleString();
        }

        function showRegionInfo(region) {
            const panel = document.getElementById('infoPanel');
            const biome = BIOMES[region.biome];
            document.getElementById('infoBiome').textContent = biome.icon + ' ' + biome.name;
            document.getElementById('infoBiome').style.color = '#' + biome.color.toString(16).padStart(6, '0');
            document.getElementById('infoName').textContent = region.name;
            document.getElementById('infoDesc').textContent = region.desc;
            document.getElementById('infoTrees').textContent = region.counts?.trees || 0;
            document.getElementById('infoHouses').textContent = region.counts?.houses || 0;
            document.getElementById('infoAnimals').textContent = region.counts?.animals || 0;
            document.getElementById('infoTemp').textContent = biome.temp;
            panel.classList.add('visible');
            clearTimeout(window.infoPanelTimeout);
            window.infoPanelTimeout = setTimeout(() => panel.classList.remove('visible'), 5000);
        }

        // ============ CONTROLS ============
        function toggleLife() {
            showLife = !showLife;
            Object.values(allObjects).forEach(arr => arr.forEach(obj => obj.visible = showLife));
            document.getElementById('btnLife').classList.toggle('active', showLife);
        }

        function toggleNight() {
            isNight = !isNight;
            nightLights.material.opacity = isNight ? 0.85 : 0;
            window.sunLight.intensity = isNight ? 0.1 : 1.3;
            window.ambientLight.intensity = isNight ? 0.15 : 0.4;
            document.getElementById('btnNight').classList.toggle('active', isNight);
        }

        function updateCamera() {
            camera.position.x = spherical.radius * Math.sin(spherical.phi) * Math.sin(spherical.theta);
            camera.position.y = spherical.radius * Math.cos(spherical.phi);
            camera.position.z = spherical.radius * Math.sin(spherical.phi) * Math.cos(spherical.theta);
            camera.lookAt(0, 0, 0);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(e) {
            if (!isDragging) return;
            const dx = e.clientX - prevMouse.x;
            const dy = e.clientY - prevMouse.y;
            spherical.theta -= dx * 0.005;
            spherical.phi = Math.max(0.2, Math.min(Math.PI - 0.2, spherical.phi + dy * 0.005));
            updateCamera();
            prevMouse = { x: e.clientX, y: e.clientY };
        }

        function onClick(e) {
            const mouse = new THREE.Vector2(
                (e.clientX / window.innerWidth) * 2 - 1,
                -(e.clientY / window.innerHeight) * 2 + 1
            );
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObject(earth);
            if (intersects.length > 0) {
                const point = intersects[0].point.normalize().multiplyScalar(EARTH_RADIUS);
                const lat = 90 - Math.acos(point.y / EARTH_RADIUS) * 180 / Math.PI;
                const lng = Math.atan2(point.z, point.x) * 180 / Math.PI - 180;
                
                // Find nearest region
                let nearest = null;
                let nearestDist = Infinity;
                regionData.forEach(region => {
                    const dist = Math.sqrt(Math.pow(lat - region.lat, 2) + Math.pow(lng - region.lng, 2));
                    if (dist < region.radius && dist < nearestDist) {
                        nearestDist = dist;
                        nearest = region;
                    }
                });
                
                if (nearest) showRegionInfo(nearest);
            }
        }

        // ============ ANIMATION ============
        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;

            if (autoRotate && !isDragging) {
                spherical.theta += 0.0006;
                updateCamera();
            }

            earth.rotation.y += 0.00015;
            nightLights.rotation.y = earth.rotation.y;
            clouds.rotation.y += 0.0002;

            // Animate trees
            allObjects.trees.forEach(tree => {
                if (tree.userData.sway !== undefined) {
                    tree.userData.sway += 0.012;
                    tree.rotation.z = Math.sin(tree.userData.sway) * 0.025;
                }
            });

            // Animate flowers
            allObjects.flowers.forEach(flower => {
                if (flower.userData.sway !== undefined) {
                    flower.userData.sway += 0.018;
                    flower.rotation.z = Math.sin(flower.userData.sway) * 0.04;
                }
            });

            // Animate animals
            allObjects.animals.forEach(animal => {
                if (!animal.userData.region) return;
                animal.userData.hop += 0.06;
                animal.userData.wanderAngle += (Math.random() - 0.5) * 0.015;
                
                const region = animal.userData.region;
                const newLat = animal.userData.lat + Math.cos(animal.userData.wanderAngle) * animal.userData.speed;
                const newLng = animal.userData.lng + Math.sin(animal.userData.wanderAngle) * animal.userData.speed;
                
                const dist = Math.sqrt(Math.pow(newLat - region.lat, 2) + Math.pow(newLng - region.lng, 2));
                if (dist < region.radius * 0.7) {
                    animal.userData.lat = newLat;
                    animal.userData.lng = newLng;
                    const hop = Math.abs(Math.sin(animal.userData.hop)) * 0.1;
                    const pos = latLngToVec3(newLat, newLng, EARTH_RADIUS + 0.3 + hop);
                    animal.position.copy(pos);
                    const normal = pos.clone().normalize();
                    animal.lookAt(pos.clone().add(normal));
                    animal.rotateX(Math.PI / 2);
                } else {
                    animal.userData.wanderAngle += Math.PI;
                }
            });

            // Animate agents
            allObjects.agents.forEach(agent => {
                if (!agent.userData.region) return;
                agent.userData.hover += 0.03;
                agent.userData.wanderAngle += (Math.random() - 0.5) * 0.01;
                
                const region = agent.userData.region;
                const newLat = agent.userData.lat + Math.cos(agent.userData.wanderAngle) * agent.userData.speed;
                const newLng = agent.userData.lng + Math.sin(agent.userData.wanderAngle) * agent.userData.speed;
                
                const dist = Math.sqrt(Math.pow(newLat - region.lat, 2) + Math.pow(newLng - region.lng, 2));
                if (dist < region.radius * 0.6) {
                    agent.userData.lat = newLat;
                    agent.userData.lng = newLng;
                    const hover = Math.sin(agent.userData.hover) * 0.4 + 2;
                    const pos = latLngToVec3(newLat, newLng, EARTH_RADIUS + hover);
                    agent.position.copy(pos);
                    const normal = pos.clone().normalize();
                    agent.lookAt(pos.clone().add(normal));
                    agent.rotateX(Math.PI / 2);
                } else {
                    agent.userData.wanderAngle += Math.PI;
                }
            });

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
